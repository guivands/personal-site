

<script src="/client/js/g2-tree.js"></script>
<script src="/client/js/remove-diacritics.js"></script>
<link rel="stylesheet" href="/client/css/g2-tree.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.css">

<!--summernote-->
<link rel="stylesheet" href="client/dist/summernote.css" />
<script src="client/dist/summernote.js"></script>
<script src="client/dist/lang/summernote-pt-BR.js"></script>

<!--angular-summernote dependencies -->
<script src="client/js/angular-summernote.min.js"></script>

<!-- summernote highlight -->
<script src="client/js/summernote-ext-highlight.js"></script>
  
<div ng-app="ngDirTree" ng-controller="dirTreeCtrl">
	<div class="row">
		<div class="col-sm-3" style="border-right:3px double #ccc">

			<select ng-model="dirTreeLocale" ng-change="redoTree()">
				<option></option>
				<option ng-repeat="loc in dirTreeLocales" value="{{ loc }}">{{ loc }}</option>
			</select>
			<br/><br/><br/>

			<!--g2-tree tree="myTree" on-select="selectNode" on-add-node="openModal"></g2-tree-->
			<g2-tree tree="myTree" on-select="selectNode" on-remove-node="removeNode"></g2-tree>
		</div>
		
		<div class="col-sm-9">
			<!-- Area de controle -->
			<div class="row dirContentMenu" style="border-bottom:1px solid #ccc;">
				<div class="col-sm-4 g2icon">
					<span ng-click="openModal()">
						<span class="glyphicon glyphicon-folder-open"></span>
						<span>&nbsp;Criar pasta</span>
					</span>
				</div>
				<div class="col-sm-4 g2icon">
					<span ng-click="newPost()">
						<span class="fa fa-file-code-o"></span>
						<span>&nbsp;Criar post</span>
					</span>
				</div>
			</div>
			
			<!-- Area de conteudo do diretorio -->
			<div class="row folder-item" ng-repeat="dir in dirContent.directories">
				<span class="g2-folder glyphicon glyphicon-folder-close"></span>
				<span>{{dir.name}}</span>
			</div>
			<div class="row folder-item" ng-repeat="post in dirContent.posts" ng-click="loadPost(post.id)" style="cursor:pointer;">
				<span class="g2-folder fa fa-file-code-o"></span>
				<span>{{post.title}}</span>
			</div>
		</div>
	</div>


	<div id="createNode" class="modal fade" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Criar Pasta</h4>
				</div>
				<form ng-submit="addNode()">
					<div class="modal-body">

						<div class="alert alert-danger" ng-repeat="msg in errMsgs">
							<strong>{{msg}}!</strong>
						</div>


						<div class="form-group">
							<label for="dirName">Diret&oacute;rio pai:</label>
							<input type="text" class="form-control" id="parentDir" ng-model="parentDir" disabled="disabled"/>
						</div>
						<div class="form-group">
							<label for="dirName">Nome:</label>
							<input type="text" class="form-control" id="dirName" ng-model="dirName" ng-blur="setPath()"/>
						</div>
						<div class="form-group">
							<label for="dirName">Caminho:</label>
							<input type="text" class="form-control" id="path" ng-model="path" ng-blur="setFullPath()"/>
						</div>
						<div class="form-group">
							<label for="dirName">Caminho completo:</label>
							<input type="text" class="form-control" id="fullpath" ng-model="fullpath" readonly="readonly"/>
						</div>
						<div class="form-group">
							<label for="dirName">Nome &Uacute;nico:</label>
							<input type="text" class="form-control" id="uniqueName" ng-model="uniqueName"/>
						</div>
						<div class="form-group">
							<label for="dirName">Locale:</label>
							<input type="text" class="form-control" id="locale" ng-model="locale"/>
						</div>
					</div>
					<div class="modal-footer">
						<input type="submit" value="Salvar" class="btn btn-info" />
						<input type="button" value="Fechar" class="btn btn-default" data-dismiss="modal" />
					</div>
				</form>
			</div>
		</div>
	</div>
	
	
	
	
	
	<!-- criacao de post -->
	<div style="height:120px;"></div>
	<hr/>
	<div style="height:30px;"></div>
	<div id="postForm" style="display:none">
		<form>
			<input type="hidden" ng-model="postId" />
			<div class="form-group">
				<label for="dirName">Nome &uacute;nico:</label>
				<input type="text" class="form-control" id="postUniqueName" ng-model="postUniqueName" ng-readonly="!isNewPost"/>
			</div>
			<div class="form-group">
				<label for="dirName">T&iacute;tulo:</label>
				<input type="text" class="form-control" id="postTitle" ng-model="postTitle" ng-blur="setPath('post')" ng-readonly="!isNewPost"/>
			</div>
			<div class="form-group">
				<label for="dirName">Description:</label>
				<input type="text" class="form-control" id="postDescription" ng-model="postDescription"/>
			</div>
			<div class="form-group">
				<label for="dirName">Tags:</label>
				<input type="text" class="form-control" id="postTags" ng-model="postTags"/>
			</div>
			<div class="form-group">
				<label for="dirName">Diret&oacute;rio:</label>
				<input type="text" class="form-control" id="postDir" ng-model="postDir" disabled="disabled"/>
			</div>
			<div class="form-group">
				<label for="dirName">Caminho:</label>
				<input type="text" class="form-control" id="postPath" ng-model="postPath" ng-blur="setFullPath('post')" ng-readonly="!isNewPost"/>
			</div>
			<div class="form-group">
				<label for="dirName">Caminho completo:</label>
				<input type="text" class="form-control" id="postFullpath" ng-model="postFullpath" readonly="readonly"/>
			</div>
			<div class="form-group">
				<label for="dirName">Locale:</label>
				<input type="text" class="form-control" id="postLocale" ng-model="postLocale" ng-readonly="!isNewPost"/>
			</div>
			<div class="form-group">
				<label for="dirName">Post:</label>
				<summernote config="options" ng-model="post"></summernote>
			</div>
			
			<input type="submit" value="Salvar" class="btn btn-info" ng-click="mergePost()" />
		</form>
	</div>
</div>

<style>
.folder-item{
	padding:3px 0px;
}
.g2icon{
	font-weight:bold;
	color:rgb(0,0,0.9);
	cursor:pointer;
}
</style>

<script>
    var app=angular.module('ngDirTree',['g2-tree','summernote']);
    app.controller('dirTreeCtrl',function($scope,$http,$interval){
        $scope.simpleToolbar=[
          ['style',['bold','italic','underline','clear']],
          ['fontsize', ['fontsize']],
          ['para', ['ul', 'ol', 'paragraph']],
          ['style',['style']],
          ['height', ['height']],
          ['ext',['link','picture','video']],
          ['highlight',['highlight']],
          ['misc',['codeview','fullscreen']],
          ['help',['help']]
        ];
        $scope.completeToolbar=[
          ['err',['undo','redo']],
          ['text',['bold','italic','underline','strikethrough','superscript','subscript','clear']],
          ['font', ['fontname','fontsize','color']],
          ['style',['style']],
          ['height', ['height']],
          ['para', ['ul', 'ol', 'paragraph']],
          ['insert',['table','hr']],
          ['ext',['link','picture','video']],
          ['highlight',['highlight']],
          ['misc',['codeview','fullscreen']],
          ['help',['help']]
        ];
        $scope.options = {
          focus:true,
          toolbar:$scope.completeToolbar
        };
        $scope.post ={};
		
		
		
		
    	$scope.selectedNode=false;
    	$scope.addRemoveArray=false;
    	$scope.tempNode;
    	$scope.myTree=[];
    	$scope.parentDir = $scope.dirName = $scope.uniqueName = '';
    	$scope.locale='pt';
    	$scope.errMsgs=[];
		$scope.dirContent = {directories:[],posts:[]};
    	$scope.selectNode=function(node){
    		$scope.selectedNode = node;
			$scope.childrenDirs = node.children;
			$scope.redoChildren();
			$scope.postDir = $scope.parentDir = node.name;
			$scope.showPost(false);
    	};
    	$scope.setPath=function(p){
			if(p=='post')
				$scope.postPath = angular.lowercase(removeDiacritics($scope.postTitle)).replace(/(\s|[^a-z0-9_.])+/g,'-');
			else
				$scope.path = angular.lowercase(removeDiacritics($scope.dirName)).replace(/(\s|[^a-z0-9_.])+/g,'-');
			$scope.setFullPath(p);
    	};
    	$scope.setFullPath=function(p){
			if(p=='post')
				$scope.postFullpath = ($scope.selectedNode ? $scope.selectedNode.fullpath + '/' : '') + $scope.postPath;
    		else
				$scope.fullpath = ($scope.selectedNode ? $scope.selectedNode.fullpath + '/' : '') + $scope.path;
    	};
    	$scope.addNode=function(){
    		var uri = "addTreeNode?name="+$scope.dirName+"&uniqueName="+$scope.uniqueName+"&locale="+$scope.locale+"&path="+$scope.path+"&fullpath="+$scope.fullpath;
    		if($scope.selectedNode)uri+="&parentId="+$scope.selectedNode.id;
    		$http({
    			method:'POST',
    			url:uri,
    			headers: { 'X-Requested-With' :'XMLHttpRequest'}
    		}).then(
    			function(res){//success
    				if (res.data.error) {
    					$scope.errMsgs=res.data.messages;
    					return;
    				}
    				if (res.data.g2Error && res.data.code == 'DIR_UNIQUE_NAME_DUPLICATE') {
    					$scope.errMsgs = ['Nome &Uacute;nico j&aacute; est&aacute; sendo utilizado'];
    					return;
    				}
					$scope.redoChildren();
    				$scope.myTree=res.data;
		    		$('#createNode').modal('hide');
		    		$scope.dirName='';
		    		$scope.uniqueName='';
		    		$scope.locale='pt';
    				$scope.errMsgs = [];
    			},
    			function(res){//error
    				console.log("error adding",res.data);
   					$scope.errMsgs = ['Um erro inesperado aconteceu'];
    			}
    		);
    	};
    	$scope.removeNode=function(node){
    		$scope.addRemoveArray=node;

			if (!confirm('Remover ' + node.id + ':' + node.name + '?')) {
				return;
			}

    		var uri = "removeTreeNode?did="+node.id+'&locale='+$scope.dirTreeLocale;
    		$http({
    			method:'POST',
    			url:uri,
    			headers: { 'X-Requested-With' :'XMLHttpRequest'}
    		}).then(
    			function(res){//success
    				if (res.data.error) {
    					var msg = '';
    					for (var i in res.data.messages) {
    						msg += res.data.messages[i] + '\n';
    					}
    					alert(msg);
    					return;
    				}
					$scope.redoChildren();
    				$scope.myTree=res.data;
    			},
    			function(res){//error
   					alert('Um erro inesperado aconteceu');
    			}
    		);
    	};
    	$scope.openModal=function(children,node){
    		$scope.addRemoveArray=children;
    		$scope.tempNode=node;
    		$scope.dirName='';
    		$('#createNode').modal('show');
    	};
    	$scope.redoTree = function() {
			$scope.dirContent = {directories:[],posts:[]};
			$scope.myTree = [];
			$scope.selectedNode=false;
			if ($scope.dirTreeLocale) {
				$scope.redoChildren();
				$http({
				  method:'GET',
				  url:'/fullDirectoryTree?locale='+$scope.dirTreeLocale
				}).then(function(res){
					$scope.myTree = res.data;
				  },
				  function(res){console.log('error',res);}
				);
			}
    	};
		$scope.redoChildren = function() {
			$scope.dirContent = {directories:[],posts:[]};
			if ($scope.dirTreeLocale) {
				var uri = '/dirContent?locale='+$scope.dirTreeLocale;
				if($scope.selectedNode) uri+='&dirId='+$scope.selectedNode.id;
				$http({
					method:'GET',
					url:uri
				}).then(function(res){
					if(res.data.g2error) {
						return console.log('error', res.data);
					}
					$scope.dirContent=res.data;
				},function(res){
					console.log('error',res);
				});
			}
		};

  		$('#createNode').on('shown.bs.modal',function(){$('#dirName').focus()});
    	/*$http({
    	  method:'GET',
    	  url:'fullDirectoryTree'
    	}).then(function(res){
    	    $scope.myTree = res.data;
    	  },
    	  function(res){console.log('error',res);}
    	);*/
    	$http({
			method:'POST',
			url:'/dirAvailableLocales',
			headers: { 'X-Requested-With' :'XMLHttpRequest'}
		}).then(
			function(res){//success
				if (res.data.error) {
					alert(res.data.messages);
					return;
				}
				$scope.dirTreeLocales = res.data;
				$scope.dirTreeLocale = $scope.dirTreeLocales[0];
				$scope.redoTree();
			},
			function(res){//error
				console.log("error adding",res.data);
				alert('Um erro inesperado aconteceu');
			}
		);
		
		
		
		
		$scope.newPost = function() {
			$scope.postUniqueName=$scope.postTitle=$scope.postDescription=$scope.postTags=$scope.postPath=$scope.postFullpath=$scope.postLocale=$scope.post=$scope.postId='';
			$scope.postFullpath=$scope.selectedNode.fullpath;
			$scope.showPost(true);
			$scope.isNewPost=true;
		};
		$scope.showPost = function(s) {
			$('#postForm').css('display',s?'block':'none');
		};
		$scope.mergePost = function() {
			console.log($scope.postFullpath);
			var pdata = {
      			uniqueName:$scope.postUniqueName,
      			title:$scope.postTitle,
      			description:$scope.postDescription,
      			tags:$scope.postTags,
      			directoryId:$scope.selectedNode.id,
      			path:$scope.postPath,
      			fullpath:$scope.postFullpath,
      			locale:$scope.postLocale,
      			post:$scope.post,
      			id:$scope.postId
      		};
			console.log(pdata);
			$http({
      			method:'POST',
      			url:'/mergePost',
      			headers: { 'X-Requested-With' :'XMLHttpRequest'},
      			data:pdata
      		}).then(
      			function(res){//success
      				if (res.data.error) {
						console.log(res.data);
      					$scope.errMsgs=res.data.messages;
      					return;
      				}
      				if (res.data.g2Error && res.data.code == 'DIR_UNIQUE_NAME_DUPLICATE') {
      					$scope.errMsgs = ['Nome único já está sendo utilizado'];
      					return;
      				}
      			},
      			function(res){//error
      				console.log("error adding",res.data);
     				$scope.errMsgs = ['Um erro inesperado aconteceu'];
      			}
      		);
        };
			
		$scope.loadPost = function(pid){
			$http({
      			method:'POST',
      			url:'/findPostById?id='+pid,
      			headers: { 'X-Requested-With' :'XMLHttpRequest'}
      		}).then(
      			function(res){//success
      				if (res.data.error) {
						console.log(res.data);
      					$scope.errMsgs=res.data.messages;
      					return;
      				}
      				if (res.data.g2Error && res.data.code == 'DIR_UNIQUE_NAME_DUPLICATE') {
      					$scope.errMsgs = ['Nome único já está sendo utilizado'];
      					return;
      				}
					$scope.postUniqueName=res.data.uniqueName;
					$scope.postTitle=res.data.title;
					$scope.postDescription=res.data.description;
					$scope.postTags=res.data.tags;
					$scope.postPath=res.data.path;
					$scope.postFullpath=res.data.fullpath;
					$scope.postLocale=res.data.locale;
					$scope.post=res.data.post;
					$scope.postId=res.data.id;
					$scope.showPost(true);
					$scope.isNewPost=false;
      			},
      			function(res){//error
      				console.log("error adding",res.data);
     				$scope.errMsgs = ['Um erro inesperado aconteceu'];
      			}
      		);
		};
    });
</script>
