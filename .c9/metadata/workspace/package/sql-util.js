{"filter":false,"title":"sql-util.js","tooltip":"/package/sql-util.js","undoManager":{"mark":43,"position":43,"stack":[[{"start":{"row":0,"column":0},"end":{"row":214,"column":0},"action":"remove","lines":["//var BizError = require('./error');","//var ERROR_CODES = require('./ERROR_CODES');","","var createSQL = function(sqlMap) {","    if (!sqlMap)","        throw new Error('Mapa de parâmetros deve ser fornecido');","    if (!sqlMap.table)","        throw new Error('Mapa de parâmetros deve ser conter o elemento table');","    var type = sqlMap.type;","\tif (!type)","\t\ttype = 'select';","    ","    switch(type) {","\t\tcase 'select': return select(sqlMap); break;","\t\tcase 'insert': ","\t\t\tif (sqlMap.where) {","\t\t\t\tthrow new Error('CREATE SQL: tipo insert não pode ter instrução where');","\t\t\t}","\t\t\tif (sqlMap.orderBy) {","\t\t\t\tthrow new Error('CREATE SQL: tipo insert não pode ter instrução orderBy');","\t\t\t}","\t\t\treturn insert(sqlMap);","\t\t\tbreak;","\t\tcase 'update':","\t\t\tif (sqlMap.orderBy) {","\t\t\t\tthrow new Error('CREATE SQL: tipo update não pode ter instrução orderBy');","\t\t\t}","\t\t\tif (sqlMap.fields) {","\t\t\t\tthrow new Error('CREATE SQL: tipo update não pode ter instrução fields');","\t\t\t}","\t\t\treturn update(sqlMap);","\t\tcase 'delete':","\t\t\tif (sqlMap.orderBy) {","\t\t\t\tthrow new Error('CREATE SQL: tipo delete não pode ter instrução orderBy');","\t\t\t}","\t\t\treturn delete(sqlMap);","\t}","};","","var insert = function(sqlMap) {","\tvar sql = 'insert into ' + sqlMap.table + ' (';","\tvar fields = '';","\tvar values = '';","\tvar params = [];","\tfor (i in sqlMap.fields) {","\t\tfields += i + ', ';","\t\tvalues += '?, ';","\t\tparams.push(sqlMap.fields[i]);","\t}","\tfields = fields.substring(0, fields.length - 2);","\tvalues = values.substring(0, values.length - 2);","\t","\tsql += fields + ') values (' + values + ')';","\treturn {'sql':sql, 'params':params};","}","","var select = function(sqlMap) {","\tvar sql = 'select ';","    var params = [];","    if (sqlMap.fields) {","        if (sqlMap.fields.push) {","            for (var i in sqlMap.fields) {","                sql = sql.concat(sqlMap.fields[i]).concat(', ');","            }","            sql = sql.substring(0, sql.length - 2);","        } else {","            sql = sql.concat(sqlMap.fields).concat(' ');","        }","    } else {","        sql = sql.concat(' * ');","    }","    ","    sql = sql.concat(' from ').concat(sqlMap.table).concat(' ');","    ","    if (sqlMap.where) {","        var ws = whereSQL(sqlMap.where, ' and ');","        sql = sql.concat(' where ' + ws.sql);","        params = params.concat(ws.params);","    }","    ","    if(sqlMap.orderBy) {","        sql += orderBy(sqlMap.orderBy);","    }","    ","    sql = sql.replace(/ +/g, ' ');","    return {'sql':sql, 'params':params};","}","","var orderBy = function(ob) {","    var sql = ' order by ';","    if (ob.push) {","        for (var i in ob) {","            sql += ob[i] + ' asc, ';","        }","        sql = sql.substring(0, sql.length -2);","    } else if (typeof ob == 'string') {","        sql += ob;","    } else {","        for(var i in ob) {","            sql += i + ' ' + ob[i] + ', ';","        }","        sql = sql.substring(0, sql.length -2);","    }","    return sql;","}","","var whereSQL = function(obj, op) {","    var ret = {sql:'', params:[]};","    ","    if (obj.push) {","        for (var i in obj) {","            var e = obj[i];","            var ws = whereSQL(e, op);","            ret.sql += ' ' + ws.sql + ' ' + op;","            ret.params = ret.params.concat(ws.params);","        }","        ret.sql = ret.sql.substring(0, ret.sql.length - op.length);","    } else if (obj.and) {","        var ws = whereSQL(obj.and, ' and ');","        ret.sql += ' ' + ws.sql + ' ';","        ret.params = ret.params.concat(ws.params);","    } else if (obj.or) {","        var ws = whereSQL(obj.or, ' or ');","        ret.sql += ' (' + ws.sql + ') ';","        ret.params = ret.params.concat(ws.params);","    } else if (typeof obj == 'string') {","        ret.sql += obj;","    } else {","        var wf = whereFields(obj, op);","        ret.sql += ' ' + wf.sql + ' ';","        ret.params = ret.params.concat(wf.params);","    }","    return ret;","};","","var whereFields = function(fields, op) {","    var ret = {sql:'', params:[]};","    for (var field in fields) {","        if (fields[field] == undefined || fields[field] == null) {","            ret.sql = ret.sql.concat(' ' + field + ' is null ' + op);","        } else {","            ret.sql = ret.sql.concat(' ' + field + ' = ? ' + op);","            ret.params.push(fields[field]);","        }","    }","    ret.sql = ret.sql.substr(0, ret.sql.length - op.length);","    return ret;","};","","var executeQuery = function (pool, sqlMap, callback) {","    pool.getConnection(function(err, connection) {","        if(err) {","            return callback(new BizError(err, ERROR_CODES.CONNECTION_ERROR, ","                'Erro ao buscar conexão do Pool de Conexões'));","        }","        try {","            var cs = createSQL(sqlMap);","            connection.query(cs.sql, cs.params, function (err, rows) {","                if(err) {","                    return callback(err);","                }","                return callback(null, rows);","            });","        } catch (err) {","            callback(err);","        }","    });","};","","","module.exports.createSQL = createSQL;","module.exports.executeQuery = executeQuery;","","","","","","var sqlMap = {","    table:'post',","    fields: ['id', 'title', 'description', 'path'],","    where:{","        and: [","            {","                or: {","                    'uniqueName': 'lalala',","                    'path': 'my_path'","                }","            },","            {","                or: {","                    'title':'Eu procuro algo',","                    'description': 'minha descricao'","                }","            }","        ]","    },","    orderBy: {","        'directoryId':'asc',","        'path':'desc'","    }","};","","var sqlMapInsert = {","\ttable:'pessoa',","\tfields:{","\t\t'nome':'guilherme',","\t\t'sobrenome':'gomes',","\t\t'idade':31","\t},","\ttype:'insert'","};","var cs = createSQL(sqlMap);","console.log(cs.sql);","console.log(cs.params);",""],"id":474},{"start":{"row":0,"column":0},"end":{"row":311,"column":2},"action":"insert","lines":["//var BizError = require('./error');","//var ERROR_CODES = require('./ERROR_CODES');","","var createSQL = function(sqlMap) {","    if (!sqlMap)","        throw new Error('Mapa de parâmetros deve ser fornecido');","    if (!sqlMap.table)","        throw new Error('Mapa de parâmetros deve ser conter o elemento table');","    var type = sqlMap.type;","\tif (!type)","\t\ttype = 'select';","    ","    switch(type) {","\t\tcase 'select': return selectSQL(sqlMap); break;","\t\tcase 'insert': ","\t\t\tif (sqlMap.where) {","\t\t\t\tthrow new Error('CREATE SQL: tipo insert não pode ter instrução where');","\t\t\t}","\t\t\tif (sqlMap.orderBy) {","\t\t\t\tthrow new Error('CREATE SQL: tipo insert não pode ter instrução orderBy');","\t\t\t}","\t\t\tif (!sqlMap.fields) {","\t\t\t\tthrow new Error('CREATE SQL: tipo update requer instrução fields');","\t\t\t}","\t\t\treturn insertSQL(sqlMap);","\t\t\tbreak;","\t\tcase 'update':","\t\t\tif (sqlMap.orderBy) {","\t\t\t\tthrow new Error('CREATE SQL: tipo update não pode ter instrução orderBy');","\t\t\t}","\t\t\tif (!sqlMap.fields) {","\t\t\t\tthrow new Error('CREATE SQL: tipo update requer instrução fields');","\t\t\t}","\t\t\treturn updateSQL(sqlMap);","\t\tcase 'delete':","\t\t\tif (sqlMap.orderBy) {","\t\t\t\tthrow new Error('CREATE SQL: tipo delete não pode ter instrução orderBy');","\t\t\t}","\t\t\tif (sqlMap.fields) {","\t\t\t\tthrow new Error('CREATE SQL: tipo delete não pode ter instrução fields');","\t\t\t}","\t\t\treturn deleteSQL(sqlMap);","\t}","};","","var deleteSQL = function(sqlMap) {","\tvar sql = 'delete from ' + sqlMap.table;","\tvar params = [];","\tif (sqlMap.where) {","\t\tsql += ' where ';","\t\tvar ws = whereSQL(sqlMap.where, ' and ');","        sql = sql.concat(' where ' + ws.sql);","        params = params.concat(ws.params);","\t}","\t","    sql = sql.replace(/ +/g, ' ');","\treturn {'sql':sql, 'params': params};","}","","var updateSQL = function(sqlMap) {","\tvar sql = 'update ' + sqlMap.table + ' set ';","\tvar params = [];","\tfor (var i in sqlMap.fields) {","\t\tsql += i + ' = ?, ';","\t\tparams.push(sqlMap.fields[i]);","\t}","\tsql = sql.substring(0, sql.length - 2);","\t","\tif (sqlMap.where) {","\t\tsql += ' where ';","\t\tvar ws = whereSQL(sqlMap.where, ' and ');","        sql = sql.concat(' where ' + ws.sql);","        params = params.concat(ws.params);","\t}","    sql = sql.replace(/ +/g, ' ');","\treturn {'sql':sql, 'params':params};","};","","var insertSQL = function(sqlMap) {","\tvar sql = 'insert into ' + sqlMap.table + ' (';","\tvar fields = '';","\tvar values = '';","\tvar params = [];","\tfor (i in sqlMap.fields) {","\t\tfields += i + ', ';","\t\tvalues += '?, ';","\t\tparams.push(sqlMap.fields[i]);","\t}","\tfields = fields.substring(0, fields.length - 2);","\tvalues = values.substring(0, values.length - 2);","\t","\tsql += fields + ') values (' + values + ')';","\treturn {'sql':sql, 'params':params};","}","","var selectSQL = function(sqlMap) {","\tvar sql = 'select ';","    var params = [];","    if (sqlMap.fields) {","        if (sqlMap.fields.push) {","            for (var i in sqlMap.fields) {","                sql = sql.concat(sqlMap.fields[i]).concat(', ');","            }","            sql = sql.substring(0, sql.length - 2);","        } else {","            sql = sql.concat(sqlMap.fields).concat(' ');","        }","    } else {","        sql = sql.concat(' * ');","    }","    ","    sql = sql.concat(' from ').concat(sqlMap.table).concat(' ');","    ","    if (sqlMap.where) {","        var ws = whereSQL(sqlMap.where, ' and ');","        sql = sql.concat(' where ' + ws.sql);","        params = params.concat(ws.params);","    }","    ","    if(sqlMap.orderBy) {","        sql += orderBy(sqlMap.orderBy);","    }","    ","    sql = sql.replace(/ +/g, ' ');","    return {'sql':sql, 'params':params};","}","","var orderBy = function(ob) {","    var sql = ' order by ';","    if (ob.push) {","        for (var i in ob) {","            sql += ob[i] + ' asc, ';","        }","        sql = sql.substring(0, sql.length -2);","    } else if (typeof ob == 'string') {","        sql += ob;","    } else {","        for(var i in ob) {","            sql += i + ' ' + ob[i] + ', ';","        }","        sql = sql.substring(0, sql.length -2);","    }","    return sql;","}","","var whereSQL = function(obj, op) {","    var ret = {sql:'', params:[]};","    ","    if (obj.push) {","        for (var i in obj) {","            var e = obj[i];","            var ws = whereSQL(e, op);","            ret.sql += ' ' + ws.sql + ' ' + op;","            ret.params = ret.params.concat(ws.params);","        }","        ret.sql = ret.sql.substring(0, ret.sql.length - op.length);","    } else if (obj.and) {","        var ws = whereSQL(obj.and, ' and ');","        ret.sql += ' ' + ws.sql + ' ';","        ret.params = ret.params.concat(ws.params);","    } else if (obj.or) {","        var ws = whereSQL(obj.or, ' or ');","        ret.sql += ' (' + ws.sql + ') ';","        ret.params = ret.params.concat(ws.params);","    } else if (typeof obj == 'string') {","        ret.sql += obj;","    } else {","        var wf = whereFields(obj, op);","        ret.sql += ' ' + wf.sql + ' ';","        ret.params = ret.params.concat(wf.params);","    }","    return ret;","};","","var whereFields = function(fields, op) {","    var ret = {sql:'', params:[]};","    for (var field in fields) {","        if (fields[field] == undefined || fields[field] == null) {","            ret.sql = ret.sql.concat(' ' + field + ' is null ' + op);","        } else if (fields[field].push) {","\t\t\tret.sql += ' ' + field + ' in (';","\t\t\tfor (var i in fields[field])  {","\t\t\t\tret.sql += '?, ';","\t\t\t\tret.params.push(fields[field][i]);","\t\t\t}","\t\t\tret.sql = ret.sql.substring(0, ret.sql.length - 2);","\t\t\tret.sql += ') ' + op;","\t\t} else {","            ret.sql = ret.sql.concat(' ' + field + ' = ? ' + op);","            ret.params.push(fields[field]);","        }","    }","    ret.sql = ret.sql.substr(0, ret.sql.length - op.length);","    return ret;","};","","var executeQuery = function (pool, sqlMap, callback) {","    pool.getConnection(function(err, connection) {","        if(err) {","            return callback(new BizError(err, ERROR_CODES.CONNECTION_ERROR, ","                'Erro ao buscar conexão do Pool de Conexões'));","        }","        try {","            var cs = createSQL(sqlMap);","            connection.query(cs.sql, cs.params, function (err, rows) {","                if(err) {","                    return callback(err);","                }","                return callback(null, rows);","            });","        } catch (err) {","            callback(err);","        }","    });","};","","","module.exports.createSQL = createSQL;","module.exports.executeQuery = executeQuery;","","","","","/*","var sqlMap = {","    table:'post',","    fields: ['id', 'title', 'description', 'path'],","    where:{","        and: [","            {","                or: {","                    'uniqueName': 'lalala',","                    'path': 'my_path'","                }","            },","            {","                or: {","                    'title':'Eu procuro algo',","                    'description': 'minha descricao'","                }","            }","        ]","    },","    orderBy: {","        'directoryId':'asc',","        'path':'desc'","    }","};","","var sqlMapInsert = {","\ttable:'pessoa',","\tfields:{","\t\t'nome':'guilherme',","\t\t'sobrenome':'gomes',","\t\t'idade':31","\t},","\ttype:'insert'","};","","var sqlMapUpdate = {","\ttable:'post',","\tfields:{","\t\t'path':'caminho_na_url'","\t},","\twhere: {","\t\t'id':11,","\t\t'description':'guilherme'","\t},","\ttype:'update'","};","","var sqlMapDelete = {","\ttable:'post',","\twhere: {","\t\tor: [","\t\t\t{and:{","\t\t\t\t'description':'guilherme',","\t\t\t\t'path':'guilherme'","\t\t\t}},","\t\t\t{and:{","\t\t\t\t'id':[2,11],","\t\t\t\t'path':'guilherme'","\t\t\t}}","\t\t]","\t},","\ttype:'delete'","};","","console.log('== SELECT ==================================================================');","var cs = createSQL(sqlMap);","console.log(cs.sql);","console.log(cs.params);","console.log('\\n');","","console.log('== INSERT ==================================================================');","cs = createSQL(sqlMapInsert);","console.log(cs.sql);","console.log(cs.params);","console.log('\\n');","","console.log('== UPDATE ==================================================================');","cs = createSQL(sqlMapUpdate);","console.log(cs.sql);","console.log(cs.params);","console.log('\\n');","","console.log('== DELETE ==================================================================');","cs = createSQL(sqlMapDelete);","console.log(cs.sql);","console.log(cs.params);","console.log('\\n');","*/"]}],[{"start":{"row":0,"column":0},"end":{"row":0,"column":1},"action":"remove","lines":["/"],"id":475}],[{"start":{"row":0,"column":0},"end":{"row":0,"column":1},"action":"remove","lines":["/"],"id":476}],[{"start":{"row":1,"column":0},"end":{"row":1,"column":1},"action":"remove","lines":["/"],"id":477}],[{"start":{"row":1,"column":0},"end":{"row":1,"column":1},"action":"remove","lines":["/"],"id":478}],[{"start":{"row":13,"column":42},"end":{"row":13,"column":49},"action":"remove","lines":[" break;"],"id":479}],[{"start":{"row":24,"column":28},"end":{"row":25,"column":9},"action":"remove","lines":["","\t\t\tbreak;"],"id":480}],[{"start":{"row":56,"column":1},"end":{"row":56,"column":2},"action":"insert","lines":[";"],"id":481}],[{"start":{"row":82,"column":6},"end":{"row":82,"column":7},"action":"insert","lines":["v"],"id":482}],[{"start":{"row":82,"column":7},"end":{"row":82,"column":8},"action":"insert","lines":["a"],"id":483}],[{"start":{"row":82,"column":8},"end":{"row":82,"column":9},"action":"insert","lines":["r"],"id":484}],[{"start":{"row":82,"column":9},"end":{"row":82,"column":10},"action":"insert","lines":[" "],"id":485}],[{"start":{"row":92,"column":1},"end":{"row":92,"column":2},"action":"insert","lines":[";"],"id":486}],[{"start":{"row":124,"column":1},"end":{"row":124,"column":2},"action":"insert","lines":[";"],"id":487}],[{"start":{"row":136,"column":15},"end":{"row":136,"column":16},"action":"remove","lines":[" "],"id":488}],[{"start":{"row":136,"column":12},"end":{"row":136,"column":15},"action":"remove","lines":["var"],"id":489}],[{"start":{"row":136,"column":12},"end":{"row":136,"column":13},"action":"insert","lines":["v"],"id":490}],[{"start":{"row":136,"column":13},"end":{"row":136,"column":14},"action":"insert","lines":["a"],"id":491}],[{"start":{"row":136,"column":14},"end":{"row":136,"column":15},"action":"insert","lines":["r"],"id":492}],[{"start":{"row":136,"column":15},"end":{"row":136,"column":16},"action":"insert","lines":[" "],"id":493}],[{"start":{"row":142,"column":1},"end":{"row":142,"column":2},"action":"insert","lines":[";"],"id":494}],[{"start":{"row":202,"column":39},"end":{"row":203,"column":0},"action":"insert","lines":["",""],"id":495},{"start":{"row":203,"column":0},"end":{"row":203,"column":12},"action":"insert","lines":["            "]}],[{"start":{"row":203,"column":12},"end":{"row":203,"column":13},"action":"insert","lines":["c"],"id":496}],[{"start":{"row":203,"column":13},"end":{"row":203,"column":14},"action":"insert","lines":["o"],"id":497}],[{"start":{"row":203,"column":14},"end":{"row":203,"column":15},"action":"insert","lines":["n"],"id":498}],[{"start":{"row":203,"column":15},"end":{"row":203,"column":16},"action":"insert","lines":["s"],"id":499}],[{"start":{"row":203,"column":16},"end":{"row":203,"column":17},"action":"insert","lines":["o"],"id":500}],[{"start":{"row":203,"column":17},"end":{"row":203,"column":18},"action":"insert","lines":["l"],"id":501}],[{"start":{"row":203,"column":18},"end":{"row":203,"column":19},"action":"insert","lines":["e"],"id":502}],[{"start":{"row":203,"column":19},"end":{"row":203,"column":20},"action":"insert","lines":["."],"id":503}],[{"start":{"row":203,"column":20},"end":{"row":203,"column":21},"action":"insert","lines":["g"],"id":504}],[{"start":{"row":203,"column":21},"end":{"row":203,"column":22},"action":"insert","lines":["l"],"id":505}],[{"start":{"row":203,"column":21},"end":{"row":203,"column":22},"action":"remove","lines":["l"],"id":506}],[{"start":{"row":203,"column":20},"end":{"row":203,"column":21},"action":"remove","lines":["g"],"id":507}],[{"start":{"row":203,"column":20},"end":{"row":203,"column":21},"action":"insert","lines":["l"],"id":508}],[{"start":{"row":203,"column":21},"end":{"row":203,"column":22},"action":"insert","lines":["o"],"id":509}],[{"start":{"row":203,"column":22},"end":{"row":203,"column":23},"action":"insert","lines":["g"],"id":510}],[{"start":{"row":203,"column":23},"end":{"row":203,"column":25},"action":"insert","lines":["()"],"id":511}],[{"start":{"row":203,"column":25},"end":{"row":203,"column":26},"action":"insert","lines":["/"],"id":512}],[{"start":{"row":203,"column":25},"end":{"row":203,"column":26},"action":"remove","lines":["/"],"id":513}],[{"start":{"row":203,"column":25},"end":{"row":203,"column":26},"action":"insert","lines":[";"],"id":514}],[{"start":{"row":203,"column":24},"end":{"row":203,"column":25},"action":"insert","lines":["c"],"id":515}],[{"start":{"row":203,"column":25},"end":{"row":203,"column":26},"action":"insert","lines":["s"],"id":516}],[{"start":{"row":203,"column":12},"end":{"row":203,"column":28},"action":"remove","lines":["console.log(cs);"],"id":517}]]},"ace":{"folds":[],"scrolltop":2648.5,"scrollleft":0,"selection":{"start":{"row":203,"column":12},"end":{"row":203,"column":12},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":3,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1466085890612,"hash":"e476a4a93fe3b62a3b3dc094d13d9ea609efcb35"}